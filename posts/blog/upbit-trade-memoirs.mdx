---
title: ë‚´ê°€ ë§Œë“  í”„ë¡œì íŠ¸ë¡œ ë‹¤ì‹œ ì •ë¦¬í•˜ëŠ” redux-saga
publishAt: 2023-10-23 14:29
thumbnailUrl: /images/blog/upbit-trade-memoirs/thumbnail.png
description: í”„ë¡œì íŠ¸ì—ì„œ redux-saga í™œìš©í•œ ë°©ë²•
tags: [websocket, redux, redux-saga, channel, upbit]
---

<center>
  <img src='/images/blog/upbit-trade-memoirs/thumbnail.png' width='400px' height='200px' />
</center>

## ëª©ì°¨

## ê°œìš”

[upbit-trade](https://chuyeonbin.github.io/upbit-trade) í”„ë¡œì íŠ¸ë¥¼ ë§Œë“ ì§€ê°€ ê½¤ ë˜ì—ˆì§€ë§Œ redux-saga ì‚¬ìš©í–ˆë˜ ê²ƒì— ëŒ€í•´ì„œ ë‹¤ì‹œ ì •ë¦¬ í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

## redux-sagaë¡œ ë Œë”ë§ ë³‘ëª©í˜„ìƒ í•´ê²°í•˜ê¸°

### íŠ¸ëŸ¬ë¸”ìŠˆíŒ… âš’ï¸

ì›ë˜ëŠ” í”„ë¡œì íŠ¸ì—ì„œ [redux-saga](https://redux-saga.js.org)ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì•„ë˜ì²˜ëŸ¼ useEffect ì•ˆì—ì„œ websocket ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜¬ë•Œë§ˆë‹¤ dispatch í•´ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

```typescript
useEffect(() => {
  const ws = new WebSocket('wss://api.upbit.com/websocket/v1');
  ws.binaryType = 'arraybuffer';

  ws.onopen = () => {
    const msg = JSON.stringify([{ ticket: 'upbit' }, { type: 'ticker', codes: ['KRW-BTC'] }]);
    ws.send(msg);
  };

  ws.onmessage = (event) => {
    const enc = new TextDecoder('utf-8');
    const arr = new Uint8Array(event.data);
    dispatch(updateSelectedCoin(JSON.parse(enc.decode(arr))));
  };

  ws.onerror = (error) => {
    throw error;
  };
}, []);
```

ì´ë ‡ê²Œ í•˜ë©´ ì½”ì¸ë°ì´í„°ê°€ í•œê°œì¼ ê²½ìš°ì—ëŠ” ë¬¸ì œì—†ì´ ë™ì‘í•˜ì§€ë§Œ upbitì—ì„œ ì œê³µí•´ì£¼ëŠ” ì½”ì¸ ë°ì´í„°ë¥¼ ëª¨ë‘ ìš”ì²­í•´ì„œ websocketìœ¼ë¡œ ë°›ê²Œ ë˜ë©´ **ë Œë”ë§ ë³‘ëª© í˜„ìƒ**ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ì—´ì‹¬íˆ êµ¬ê¸€ë§ í•˜ë‹¤ê°€ [redux-saga](https://redux-saga.js.org/)ì—ì„œ ì œê³µí•´ì£¼ëŠ” [channel](https://redux-saga.js.org/docs/advanced/Channels/)ì´ë¼ëŠ” ê²ƒì„ ì•Œê²Œë˜ì–´ ë„ì…í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

### ê°œì„  âœ¨

### redux-saga channelì´ë€

redux-sagaì˜ channelì€ ë°ì´í„°ë¥¼ ê³„ì† ë°€ì–´ë„£ëŠ” websocketì˜ **push** ê¸°ë°˜ê³¼ ê·¸ë¦¬ê³  take/putê³¼ ê°™ì´ ì´í™íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” **pull** ê¸°ë°˜ì˜ ë™ì‘ì„ ì¼ë°˜í™” ì‹œì¼œì£¼ëŠ” ì—­í• ì„ ìˆ˜í–‰ í•©ë‹ˆë‹¤.

### 1. íŒ©í† ë¦¬ í•¨ìˆ˜ ë§Œë“¤ê¸°

ìš°ì„  ì´ëŸ°ì‹ìœ¼ë¡œ eventChannelì„ returní•´ì£¼ëŠ” íŒ©í† ë¦¬ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.

```typescript
function channelConnection(field: {
  type: 'ticker' | 'trade' | 'orderbook';
  codes: string[];
}): EventChannel<string> {
  return eventChannel(
    (emitter) => {
      const ws = createSocket();

      ws.onopen = () => {
        const msg = JSON.stringify([{ ticket: 'upbit' }, field]);
        ws.send(msg);
      };

      ws.onmessage = (event) => {
        const enc = new TextDecoder('utf-8');
        const arr = new Uint8Array(event.data);
        emitter(JSON.parse(enc.decode(arr)));
      };

      ws.onerror = (error) => {
        throw error;
      };

      ws.close = () => {
        emitter(END);
      };

      return function unsubscribe() {
        ws.close();
      };
    },
    buffers.expanding(200) || buffers.none(),
  );
}
```

ë©”ì‹œì§€ê°€ ìˆ˜ì‹  ë  ë•Œë§ˆë‹¤ emitterë¡œ ë²„í¼ì— ì €ì¥í•˜ê³  ë²„í¼ì˜ ì‚¬ì´ì¦ˆëŠ” 200ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

### 2. buffer ë°ì´í„° ì‚¬ìš©í•˜ê¸°

ì½”ì¸ ë°ì´í„°ì˜ í˜„ì¬ê°€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•„ì˜¤ëŠ” saga í•¨ìˆ˜ì—ì„œ bufferì— ì €ì¥ë˜ì–´ìˆëŠ” ë©”ì‹œì§€ë¥¼ **flush** ì´í™íŠ¸ë¡œ ê°€ì ¸ì˜¤ê³  **delay** ì´í™íŠ¸ë¡œ 0.5ì´ˆì— í•œë²ˆì”© put ì´í™íŠ¸ê°€ ì‹¤í–‰ë˜ê²Œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

```typescript
export function* presentPriceSocketSaga({ payload }: PayloadAction<{ codes: string[] }>) {
  let channel: EventChannel<RealTimeTickers>;
  try {
    channel = yield call(channelConnection, { type: 'ticker', codes: payload.codes });
    yield put(presentPriceSocketSuccess());

    while (true) {
      const msg: RealTimeTickers = yield flush(channel);
      const {
        coin: { selectedCoin },
      }: RootState = yield select();

      if (msg.length) {
        yield put(updateTickerList(msg));
      }

      if (msg.find((value) => value.code === selectedCoin.market)) {
        yield put(updateSelectedCoin(msg));
      }

      yield delay(500); // 0.5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    }
  } catch (error) {
    console.error(error);
    yield put(presentPriceSocketFailure(error));
  } finally {
    closeChannel(channel!);
  }
}
```

ê²°ê³¼ì ìœ¼ë¡œ useEffect ì•ˆì—ì„œ websocket ë©”ì‹œì§€ë¥¼ dispatch í•´ì£¼ëŠ” ë°©ì‹ì˜ **ë Œë”ë§ ë³‘ëª© í˜„ìƒ**ì„ redux-sagaì˜ channelê³¼ bufferë¥¼ í™œìš©í•´ì„œ ê°œì„ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

### ê²°ê³¼

**1ì´ˆ 100ë²ˆ ì´ìƒ ë Œë”ë§**ğŸ’© -> **1ì´ˆì— 2ë²ˆ ë Œë”ë§ìœ¼ë¡œ ê°œì„ âœ¨**
![](/images/blog/upbit-trade-memoirs/1.gif)

## throttle effectë¡œ api ìš”ì²­ ìˆ˜ ì œí•œí•˜ê¸°

### íŠ¸ëŸ¬ë¸”ìŠˆíŒ… âš’ï¸

ê°œë°œì„ ì§„í–‰í•˜ë‹¤ê°€ ì´ì „ ì½”ì¸ë°ì´í„° í•œë²ˆë§Œ ìš”ì²­í•´ì•¼ í•˜ëŠ”ë° ê°™ì€ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ë²ˆ í˜¸ì¶œì„ í•˜ëŠ” ì´ìŠˆê°€ ë°œìƒ í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ throttle effectë¡œ ì´ì „ ì½”ì¸ë°ì´í„°ë¥¼ ìš”ì²­í•˜ëŠ” actionë“¤ì„ ì¼ì • ì‹œê°„ë™ì•ˆ ì§€ì—° ì‹œì¼œì„œ í•œê°œì˜ ìš”ì²­ë§Œ ì „ë‹¬ë˜ê²Œë” í•´ì„œ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

### ê°œì„  âœ¨

### throttleì´ë€

**throttle** ì€ ì´ë²¤íŠ¸ë¥¼ ì¼ì •í•œ ì£¼ê¸°ë§ˆë‹¤ ë°œìƒí•˜ë„ë¡ í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ Throttle ì˜ ì„¤ì •ì‹œê°„ìœ¼ë¡œ 1ms ë¥¼ ì£¼ê²Œë˜ë©´ í•´ë‹¹ ì´ë²¤íŠ¸ëŠ” 1ms ë™ì•ˆ ìµœëŒ€ í•œë²ˆë§Œ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ throttle effectë¥¼ ì‚¬ìš©í•´ì„œ dispatch ëœ ì•¡ì…˜ë“¤ì— ì“°ë¡œë“¤ë§ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê¸°ì¡´ì½”ë“œ

```typescript
function* watchPrevCandleDataSaga() {
  yield takeEvery(loadPrevCandleData, loadPrevCandleDataSaga);
}

function* watchChangeCandleDataSaga() {
  yield takeEvery(changeCandleData, changeCandleDataSaga);
}

function* watchChangeSelectedCoinSaga() {
  yield takeEvery(changeSelectedCoin, changeSelectedCoinSaga);
}

export default function* coinSaga() {
  yield all([
    fork(watchChangeSelectedCoinSaga),
    fork(watchChangeCandleDataSaga),
    fork(watchPrevCandleDataSaga),
  ]);
}
```

### throttle ì ìš© ì½”ë“œ

```typescript
function* watchPrevCandleDataSaga() {
  yield throttle(500, loadPrevCandleData, loadPrevCandleDataSaga);
}

function* watchChangeCandleDataSaga() {
  yield takeEvery(changeCandleData, changeCandleDataSaga);
}

function* watchChangeSelectedCoinSaga() {
  yield takeEvery(changeSelectedCoin, changeSelectedCoinSaga);
}

export default function* coinSaga() {
  yield all([
    fork(watchChangeSelectedCoinSaga),
    fork(watchChangeCandleDataSaga),
    fork(watchPrevCandleDataSaga),
  ]);
}
```

### ê²°ê³¼

**throttle ì ìš© ì „**

<img src='/images/blog/upbit-trade-memoirs/2.gif' width='1000' />

**throttle ì ìš© í›„**

<img src='/images/blog/upbit-trade-memoirs/3.gif' width='1000' />

**ê°™ì€ ì´ì „ ìº”ë“¤ë°ì´í„° ì—¬ëŸ¬ë²ˆ í˜¸ì¶œ**ğŸ’© -> **ê°™ì€ ì´ì „ ìº”ë“¤ë°ì´í„° 1ë²ˆì”©ë§Œ í˜¸ì¶œ**âœ¨

## ì°¸ê³ 

https://seongkyun-yu.github.io/2020/11/19/0053-websocket-with-redux-saga

https://redux-saga.js.org/docs/advanced/Channels

https://meetup.nhncloud.com/posts/114

```

```
